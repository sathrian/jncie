## Last changed: 2019-03-06 14:30:46 PST
version 18.4R1.8;
groups {
    pki {
        security {
            pki {
                ca-profile advpn {
                    ca-identity advpn;
                    revocation-check {
                        disable;
                    }
                }
            }
        }
    }
    node0 {
        system {
            host-name central-node0;
        }
        interfaces {
            fxp0 {
                unit 0 {
                    family inet {
                        address 10.10.1.3/24;
                    }
                }
            }
        }
    }
    node1 {
        system {
            host-name central-node1;
        }
        interfaces {
            fxp0 {
                unit 0 {
                    family inet {
                        address 10.10.1.4/24;
                    }
                }
            }
        }
    }
}
apply-groups [ pki "${node}" ];
system {
    login {
        class admin {
            permissions all;
            deny-commands "request system reboot";
        }
        class restricted {
            permissions clear;
            allow-commands "(show system users)|(show interfaces terse)";
        }
        class ronly {
            permissions [ view view-configuration ];
            deny-commands "file delete";
            deny-configuration "system login";
        }
        user admin1 {
            uid 2007;
            class admin;
            authentication {
                encrypted-password "$1$2Ufc.UpI$s/SmYOgJSv33V5HlhwOqO1"; ## SECRET-DATA
            }
        }
        user lab {
            uid 2009;
            class super-user;
            authentication {
                encrypted-password "$1$hfW4uwbb$C5GrqK6JMX/y2o54.1jWz0"; ## SECRET-DATA
            }
        }
        user restricted {
            uid 2010;
            class restricted;
            authentication {
                encrypted-password "$1$XuzfeAyb$PVeSVjo2Y5Jgc6WFh6Hhm."; ## SECRET-DATA
            }
        }
        user ronly {
            uid 2015;
            class ronly;
            authentication {
                encrypted-password "$1$JsllqvQw$a/vER20W/pfwUPGHAfdtT1"; ## SECRET-DATA
            }
        }
    }
    root-authentication {
        encrypted-password "$6$hl4J65Ln$zBTLOocF4qpXQAhODfjzHSE/Y1iE2g0BeD1I/Loa0H.CCfUlhoSpCit4I9Djt/R.xIMlBBqW5Psedchsp73he0"; ## SECRET-DATA
    }
    services {
        ssh {
            root-login allow;
            connection-limit 3;
        }
        telnet;
        web-management {
            https {
                system-generated-certificate;
            }
        }
    }
    host-name central-node0;
    time-zone America/Los_Angeles;
    name-server {
        8.8.8.8;
    }
    syslog {
        user * {
            any emergency;
        }
        host 10.10.1.99 {
            any emergency;
            authorization info;
        }
        file messages {
            any critical;
        }
        file interactive-commands {
            interactive-commands any;
        }
        file security-policy-logs {
            user info;
            match RT_FLOW;
            archive size 512k files 20;
        }
        file authorization-file {
            authorization any;
        }
        file ssl-proxy {
            any any;
            match SSL;
        }
        time-format year millisecond;
    }
    ntp {
        boot-server 10.10.1.254;
        server 10.10.1.254;
        trusted-key 1;
    }
}
chassis {
    cluster {
        reth-count 4;
        redundancy-group 0 {
            node 0 priority 1;
            node 1 priority 100;
        }
        redundancy-group 1 {
            node 0 priority 100;
            node 1 priority 1;
            preempt;
            interface-monitor {
                ge-0/0/4 weight 255;
                ge-7/0/4 weight 255;
            }
        }
        redundancy-group 2 {
            node 0 priority 1;
            node 1 priority 100;
            preempt;
        }
    }
}
services {
    rpm {
        probe ping-9 {
            test icmp {
                probe-type icmp-ping;
                target address 12.34.56.78;
                probe-count 3;
                probe-interval 5;
                test-interval 15;
                thresholds {
                    successive-loss 3;
                    total-loss 3;
                }
                next-hop 80.1.1.9;
            }
        }
        probe ping-13 {
            test icmp {
                probe-type icmp-ping;
                target address 12.34.56.78;
                probe-count 3;
                probe-interval 5;
                test-interval 15;
                thresholds {
                    successive-loss 3;
                    total-loss 3;
                }
                next-hop 80.1.1.13;
            }
        }
    }
    application-identification {
        no-application-system-cache;
    }
    ssl {
        proxy {
            profile CENTRAL-SSL {
                root-ca MY-CERT;
                actions {
                    ignore-server-auth-failure;
                    log {
                        all;
                    }
                }
            }
        }
    }
    user-identification {
        identity-management {
            connection {
                connect-method https;
                port 443;
                primary {
                    address 10.10.1.121;
                    client-id jncie;
                    client-secret "$9$wv2oGzF/tpBk.Qn/9pu8XxdYg"; ## SECRET-DATA
                }
                token-api oauth_token/oauth;
                query-api user_query/v2;
            }
        }
    }
    ip-monitoring {
        policy ping-9 {
            match {
                rpm-probe ping-9;
            }
            then {
                interface ge-0/0/3 {
                    disable;
                }
            }
        }
        policy ping-13 {
            match {
                rpm-probe ping-13;
            }
            then {
                interface ge-7/0/3 {
                    disable;
                }
            }
        }
    }
}
security {
    pki {
        ca-profile advpn {
            ca-identity advpn;
            revocation-check {
                disable;
                crl {
                    disable on-download-failure;
                }
            }
        }
    }
    ike {
        proposal advpn-ike-prop {
            authentication-method rsa-signatures;
        }
        proposal IKE-PROP-HOFFICE {
            authentication-method pre-shared-keys;
            dh-group group1;
            authentication-algorithm md5;
            encryption-algorithm des-cbc;
        }
        policy advpn-pol1 {
            mode main;
            proposals advpn-ike-prop;
            certificate {
                local-certificate srx3;
            }
        }
        policy IKE-POL-HOFFICE {
            mode main;
            proposals IKE-PROP-HOFFICE;
            pre-shared-key ascii-text "$9$qPT3ApBSrv69rvWLVb.P5"; ## SECRET-DATA
        }
        gateway advpn-gw1 {
            ike-policy advpn-pol1;
            dynamic {
                distinguished-name {
                    wildcard O=Juniper;
                }
                ike-user-type group-ike-id;
            }
            local-identity distinguished-name;
            external-interface lo0;
            local-address 80.1.1.16;
            advpn {
                partner {
                    disable;
                }
            }
            version v2-only;
        }
        gateway TO-HOFFICE {
            ike-policy IKE-POL-HOFFICE;
            address 200.1.1.100;
            external-interface lo0.0;
        }
    }
    ipsec {
        proposal ipsecprop {
            protocol esp;
            authentication-algorithm hmac-sha-256-128;
            encryption-algorithm aes-256-cbc;
            lifetime-seconds 3600;
        }
        proposal IPSEC-PROP-HOFFICE {
            protocol esp;
            authentication-algorithm hmac-md5-96;
            encryption-algorithm des-cbc;
        }
        policy ipsecpol {
            proposals ipsecprop;
        }
        policy IPSEC-POL-HOFFICE {
            proposals IPSEC-PROP-HOFFICE;
        }
        vpn advpn-vpn {
            bind-interface st0.0;
            ike {
                gateway advpn-gw1;
                ipsec-policy ipsecpol;
            }
        }
        vpn TO-HOFFICE {
            bind-interface st0.1;
            ike {
                gateway TO-HOFFICE;
                proxy-identity {
                    local 172.16.0.0/16;
                    remote 172.16.77.0/24;
                    service any;
                }
                ipsec-policy IPSEC-POL-HOFFICE;
            }
            establish-tunnels immediately;
        }
    }
    idp {
        idp-policy CENTRAL-IDP {
            rulebase-ips {
                rule FILE-ATTACK {
                    match {
                        from-zone any;
                        source-address any;
                        to-zone WAREHOUSE;
                        destination-address WAREHOUSE-SRV-206;
                        application junos-ftp;
                        attacks {
                            custom-attacks FILE-ATTACK;
                        }
                    }
                    then {
                        action {
                            drop-connection;
                        }
                    }
                }
                rule ANONYMOUS-ATTACK {
                    match {
                        from-zone any;
                        source-address any;
                        to-zone WAREHOUSE;
                        destination-address WAREHOUSE-SRV-206;
                        application junos-ftp;
                        attacks {
                            custom-attacks ANONYMOUS-ATTACK;
                        }
                    }
                    then {
                        action {
                            drop-packet;
                        }
                        ip-action {
                            ip-block;
                            target source-address;
                            timeout 3600;
                        }
                        notification {
                            log-attacks {
                                alert;
                            }
                        }
                    }
                }
            }
            rulebase-exempt {
                rule FILE-ATTACK {
                    match {
                        from-zone TRUST;
                        source-address any;
                        to-zone WAREHOUSE;
                        destination-address WAREHOUSE-SRV-206;
                        attacks {
                            custom-attacks FILE-ATTACK;
                        }
                    }
                }
                rule ANONYMOUS-TRUST {
                    match {
                        from-zone TRUST;
                        source-address any;
                        to-zone WAREHOUSE;
                        destination-address WAREHOUSE-SRV-206;
                        attacks {
                            custom-attacks ANONYMOUS-ATTACK;
                        }
                    }
                }
                rule ANONYMOUS-TESTBED {
                    match {
                        from-zone TESTBED;
                        source-address any;
                        to-zone WAREHOUSE;
                        destination-address WAREHOUSE-SRV-206;
                        attacks {
                            custom-attacks ANONYMOUS-ATTACK;
                        }
                    }
                }
            }
        }
        custom-attack FILE-ATTACK {
            severity major;
            attack-type {
                chain {
                    expression "exe or rpm";
                    member exe {
                        attack-type {
                            signature {
                                context ftp-put-filename;
                                pattern ".*\.\[exe\]";
                                direction client-to-server;
                            }
                        }
                    }
                    member rpm {
                        attack-type {
                            signature {
                                context ftp-put-filename;
                                pattern ".*\.\[rpm\]";
                                direction client-to-server;
                            }
                        }
                    }
                }
            }
        }
        custom-attack ANONYMOUS-ATTACK {
            severity major;
            attack-type {
                signature {
                    context ftp-username;
                    pattern "^anonymous$";
                    direction client-to-server;
                }
            }
        }
    }
    address-book {
        global {
            address CENTRAL-TRUST 172.16.50.0/24;
            address CENTRAL-INTERNAL 172.16.55.0/24;
            address CENTRAL-WAREHOUSE 172.16.60.0/24;
            address CENTRAL-TESTBED6 172.16.65.0/24;
            address CENTRAL-TESTBED7 172.16.70.0/24;
            address SRV-MAIL 172.16.60.199/32;
            address WAREHOUSE-SRV-205 172.16.60.205/32;
            address WAREHOUSE-SRV-206 172.16.60.206/32;
            address WAREHOUSE-HONEYPOT 172.16.60.207/32;
            address RO1-TRUST 172.16.10.0/24;
            address RO2-TRUST 172.16.20.0/24;
            address EXA-TRUST 172.16.10.0/24;
            address WEBSENSE 172.16.60.99/32;
            address RO1-HOST-PRIVATE 172.16.11.50/32;
            address RO2-SRV-WEB 172.16.21.2/32;
            address RO2-SRV-DB 172.16.21.33/32;
            address EXA-SRV-WEB 172.16.30.11/32;
            address EXA-SRV-DB 172.16.30.12/32;
            address EXA-SRV-SSH 172.16.30.13/32;
            address EXA-PRIVATE 172.16.15.0/24;
            address HOFFICE-TRUST 172.16.77.0/24;
            address EXA-TRUST-OVERLAP 172.16.110.0/24;
            address RO1-TRUST-OVERLAP 172.16.111.0/24;
            address BUILDING-TRUST-B1 172.16.100.0/24;
            address BUILDING-TRUST-B2 172.16.200.0/24;
            address BUILDING-DMZ-B2 172.16.201.0/24;
            address BUILDING-DMZ-B1 172.16.101.0/24;
            address-set CENTRAL-TESTBED {
                address CENTRAL-TESTBED6;
                address CENTRAL-TESTBED7;
            }
            address-set TRUST-NETWORKS {
                address RO1-TRUST;
                address RO2-TRUST;
                address CENTRAL-TRUST;
                address HOFFICE-TRUST;
                address EXA-TRUST-OVERLAP;
                address RO1-TRUST-OVERLAP;
                address BUILDING-TRUST-B1;
                address BUILDING-TRUST-B2;
            }
        }
    }
    application-tracking {
        first-update-interval 2;
        session-update-interval 6;
    }
    utm {
        custom-objects {
            filename-extension {
                bat-sh {
                    value [ bat sh ];
                }
            }
            url-pattern {
                spam-sources {
                    value [ 4.4.4.4 5.5.5.5 45.45.45.45 spam.com bad.com "spam@gmail.com" "spam@yahoo.com" ];
                }
            }
        }
        default-configuration {
            anti-spam {
                type sbl;
            }
        }
        feature-profile {
            anti-spam {
                address-blacklist spam-sources;
                sbl {
                    profile smtp-protect {
                        no-sbl-default-server;
                        spam-action block;
                    }
                }
            }
            content-filtering {
                profile CENTRAL-content-filter {
                    block-extension bat-sh;
                    block-content-type {
                        java-applet;
                        http-cookie;
                    }
                    notification-options {
                        type protocol-only;
                        custom-message "Firewall blocked this content!";
                    }
                }
            }
        }
        utm-policy CENTRAL-Content {
            content-filtering {
                http-profile CENTRAL-content-filter;
                ftp {
                    upload-profile CENTRAL-content-filter;
                    download-profile CENTRAL-content-filter;
                }
            }
        }
        utm-policy CENTRAL-SPAM {
            anti-spam {
                smtp-profile smtp-protect;
            }
        }
    }
    nat {
        source {
            pool INTERNET {
                address {
                    80.1.1.128/32 to 80.1.1.159/32;
                }
            }
            pool WEBSENSE {
                address {
                    80.1.1.160/32;
                }
            }
            rule-set UNTRUST {
                from zone [ INTERNAL TRUST WAREHOUSE ];
                to zone UNTRUST;
                rule WEBSENSE {
                    match {
                        source-address 172.16.60.99/32;
                        destination-address 0.0.0.0/0;
                    }
                    then {
                        source-nat {
                            pool {
                                WEBSENSE;
                            }
                        }
                    }
                }
                rule INTERNET {
                    match {
                        source-address [ 172.16.50.0/24 172.16.55.0/24 ];
                        destination-address 0.0.0.0/0;
                    }
                    then {
                        source-nat {
                            pool {
                                INTERNET;
                            }
                        }
                    }
                }
            }
        }
        destination {
            pool WAREHOUSE-SRV-WEB {
                address 172.16.60.205/32 port 80;
            }
            pool WAREHOUSE-SRV-DB {
                address 172.16.60.205/32;
            }
            pool WAREHOUSE-SRV-SSH {
                address 172.16.60.206/32;
            }
            pool WAREHOUSE-HONEYPOT {
                address 172.16.60.207/32;
            }
            rule-set SERVERS {
                from zone UNTRUST;
                rule WAREHOUSE-SRV-WEB {
                    match {
                        destination-address 80.1.1.200/32;
                        destination-port {
                            8080;
                        }
                    }
                    then {
                        destination-nat {
                            pool {
                                WAREHOUSE-SRV-WEB;
                            }
                        }
                    }
                }
                rule WAREHOUSE-SRV-DB {
                    match {
                        destination-address 80.1.1.200/32;
                        destination-port {
                            3306;
                        }
                    }
                    then {
                        destination-nat {
                            pool {
                                WAREHOUSE-SRV-DB;
                            }
                        }
                    }
                }
                rule WAREHOUSE-SRV-SSH {
                    match {
                        destination-address 80.1.1.201/32;
                        destination-port {
                            22;
                        }
                    }
                    then {
                        destination-nat {
                            pool {
                                WAREHOUSE-SRV-SSH;
                            }
                        }
                    }
                }
                rule WAREHOUSE-HONEYPOT {
                    match {
                        destination-address 80.1.1.202/32;
                    }
                    then {
                        destination-nat {
                            pool {
                                WAREHOUSE-HONEYPOT;
                            }
                        }
                    }
                }
            }
        }
        static {
            rule-set SRV-MAIL {
                from zone UNTRUST;
                rule mail {
                    match {
                        destination-address 80.1.1.192/32;
                    }
                    then {
                        static-nat {
                            prefix {
                                172.16.60.199/32;
                            }
                        }
                    }
                }
            }
        }
    }
    policies {
        from-zone TRUST to-zone UNTRUST {
            policy HTTP-FTP {
                match {
                    source-address CENTRAL-TRUST;
                    destination-address any;
                    application [ junos-http junos-ftp ];
                    dynamic-application junos:MSN;
                }
                then {
                    permit {
                        application-services {
                            utm-policy CENTRAL-Content;
                            application-traffic-control {
                                rule-set MEGA;
                            }
                        }
                    }
                    log {
                        session-init;
                        session-close;
                    }
                }
            }
            policy INTERNET {
                match {
                    source-address CENTRAL-TRUST;
                    destination-address any;
                    application any;
                }
                then {
                    permit;
                }
            }
        }
        from-zone UNTRUST to-zone WAREHOUSE {
            policy SRV-MAIL {
                match {
                    source-address any;
                    destination-address SRV-MAIL;
                    application junos-smtp;
                }
                then {
                    permit {
                        destination-address {
                            drop-untranslated;
                        }
                        application-services {
                            utm-policy CENTRAL-SPAM;
                        }
                    }
                }
            }
            policy SERVERS {
                match {
                    source-address any;
                    destination-address [ WAREHOUSE-SRV-205 WAREHOUSE-SRV-206 WAREHOUSE-HONEYPOT ];
                    application any;
                }
                then {
                    permit {
                        destination-address {
                            drop-untranslated;
                        }
                        application-services {
                            idp;
                        }
                    }
                }
            }
        }
        from-zone INTERNAL to-zone WAREHOUSE {
            policy WEBSENSE {
                match {
                    source-address CENTRAL-INTERNAL;
                    destination-address any;
                    application junos-http;
                }
                then {
                    permit;
                }
            }
        }
        from-zone TESTBED to-zone WAREHOUSE {
            policy WEBSENSE {
                match {
                    source-address CENTRAL-TESTBED;
                    destination-address any;
                    application junos-http;
                    dynamic-application junos:HTTP;
                }
                then {
                    permit;
                    log {
                        session-init;
                        session-close;
                    }
                }
            }
        }
        from-zone WAREHOUSE to-zone UNTRUST {
            policy WEBSENSE {
                match {
                    source-address WEBSENSE;
                    destination-address any;
                    application junos-http;
                }
                then {
                    permit;
                }
            }
            policy SRV-MAIL {
                match {
                    source-address SRV-MAIL;
                    destination-address any;
                    application any;
                }
                then {
                    permit;
                }
            }
        }
        from-zone INTERNAL to-zone UNTRUST {
            policy INTERNET {
                match {
                    source-address CENTRAL-INTERNAL;
                    destination-address any;
                    application any;
                }
                then {
                    permit;
                }
            }
        }
        from-zone UNTRUST to-zone UNTRUST {
            policy UNTRUST {
                match {
                    source-address any;
                    destination-address any;
                    application any;
                }
                then {
                    permit;
                }
            }
        }
        from-zone TESTBED to-zone UNTRUST {
            policy HTTPS {
                match {
                    source-address CENTRAL-TESTBED;
                    destination-address any;
                    application junos-https;
                }
                then {
                    permit {
                        application-services {
                            ssl-proxy {
                                profile-name CENTRAL-SSL;
                            }
                        }
                    }
                }
            }
        }
        from-zone WAREHOUSE to-zone WAREHOUSE {
            policy WAREHOUSE {
                match {
                    source-address any;
                    destination-address any;
                    application any;
                }
                then {
                    permit;
                }
            }
        }
        global {
            policy WAREHOUSE {
                match {
                    source-address any;
                    destination-address CENTRAL-WAREHOUSE;
                    application junos-ftp;
                    to-zone WAREHOUSE;
                }
                then {
                    permit {
                        application-services {
                            idp;
                        }
                    }
                }
            }
            policy TRUST {
                match {
                    source-address TRUST-NETWORKS;
                    destination-address TRUST-NETWORKS;
                    application any;
                    source-identity any;
                }
                then {
                    permit;
                }
            }
        }
    }
    zones {
        security-zone UNTRUST {
            host-inbound-traffic {
                system-services {
                    ping;
                }
                protocols {
                    bgp;
                }
            }
            interfaces {
                lo0.0 {
                    host-inbound-traffic {
                        system-services {
                            ike;
                            ping;
                        }
                        protocols {
                            ldp;
                            bgp;
                        }
                    }
                }
                ge-0/0/3.0;
                ge-7/0/3.0;
            }
        }
        security-zone TRUST {
            host-inbound-traffic {
                system-services {
                    ping;
                    ssh;
                }
            }
            interfaces {
                reth0.50;
            }
            application-tracking;
        }
        security-zone INTERNAL {
            host-inbound-traffic {
                system-services {
                    ping;
                }
            }
            interfaces {
                reth0.55;
            }
            advance-policy-based-routing-profile {
                apbr;
            }
        }
        security-zone WAREHOUSE {
            host-inbound-traffic {
                system-services {
                    ping;
                }
            }
            interfaces {
                reth0.60;
            }
        }
        security-zone TESTBED {
            host-inbound-traffic {
                system-services {
                    ping;
                }
            }
            interfaces {
                reth0.65;
                reth0.70;
            }
        }
        security-zone VPN {
            host-inbound-traffic {
                system-services {
                    ping;
                }
            }
            interfaces {
                st0.0 {
                    host-inbound-traffic {
                        protocols {
                            bgp;
                            ospf;
                        }
                    }
                }
                st0.1;
            }
        }
    }
    advance-policy-based-routing {
        profile apbr {
            rule 1 {
                match {
                    dynamic-application junos:SOUNDCLOUD;
                }
                then {
                    routing-instance apbr;
                }
            }
        }
    }
}
interfaces {
    ge-0/0/3 {
        unit 0 {
            family inet {
                address 80.1.1.10/30;
            }
            family inet6 {
                address 2016:abcd::a/126;
            }
        }
    }
    ge-0/0/4 {
        gigether-options {
            redundant-parent reth0;
        }
    }
    ge-7/0/3 {
        unit 0 {
            family inet {
                address 80.1.1.14/30;
            }
            family inet6 {
                address 2016:abcd::e/126;
            }
        }
    }
    ge-7/0/4 {
        gigether-options {
            redundant-parent reth0;
        }
    }
    fab0 {
        fabric-options {
            member-interfaces {
                ge-0/0/2;
            }
        }
    }
    fab1 {
        fabric-options {
            member-interfaces {
                ge-7/0/2;
            }
        }
    }
    lo0 {
        unit 0 {
            family inet {
                filter {
                    input RE-PROTECT-v4;
                }
                address 80.1.1.16/32 {
                    primary;
                }
                address 192.168.1.3/32;
            }
        }
        redundant-pseudo-interface-options {
            redundancy-group 2;
        }
    }
    reth0 {
        vlan-tagging;
        redundant-ether-options {
            redundancy-group 1;
        }
        unit 50 {
            vlan-id 50;
            family inet {
                address 172.16.50.254/24;
            }
            family inet6 {
                address 2016:abcd:a1::254/64;
            }
        }
        unit 55 {
            vlan-id 55;
            family inet {
                address 172.16.55.254/24;
            }
        }
        unit 60 {
            vlan-id 60;
            family inet {
                address 172.16.60.254/24;
            }
        }
        unit 65 {
            vlan-id 65;
            family inet {
                address 172.16.65.254/24;
            }
        }
        unit 70 {
            vlan-id 70;
            family inet {
                address 172.16.70.254/24;
            }
        }
    }
    st0 {
        unit 0 {
            multipoint;
            family inet {
                address 11.0.0.4/24;
            }
        }
        unit 1 {
            family inet;
        }
    }
}
policy-options {
    prefix-list mgmt {
        10.0.0.0/8;
        80.1.1.16/32;
        172.16.0.0/16;
        192.168.1.3/32;
    }
    prefix-list bgp {
        apply-path "protocols bgp group <*> neighbor <*>";
    }
    policy-statement WAREHOUSE {
        term NETWORK {
            from {
                protocol direct;
                route-filter 172.16.60.0/24 exact;
            }
            then accept;
        }
        term else {
            then reject;
        }
    }
    policy-statement apbr {
        term 1 {
            from interface [ ge-0/0/3.0 ge-7/0/3.0 ];
            to rib apbr.inet.0;
            then accept;
        }
        term 2 {
            then reject;
        }
    }
    policy-statement from-bgp13 {
        term default {
            from {
                protocol bgp;
                route-filter 0.0.0.0/0 exact;
            }
            then accept;
        }
        term specific {
            from {
                protocol bgp;
                route-filter 0.0.0.0/0 longer;
            }
            then {
                local-preference 200;
                accept;
            }
        }
    }
    policy-statement from-bgp9 {
        term default {
            from {
                protocol bgp;
                route-filter 0.0.0.0/0 exact;
            }
            then {
                local-preference 200;
                accept;
            }
        }
        term specific {
            from {
                protocol bgp;
                route-filter 0.0.0.0/0 longer;
            }
            then accept;
        }
    }
    policy-statement no-bgp {
        term bgp {
            from protocol bgp;
            then reject;
        }
        term else {
            then accept;
        }
    }
    policy-statement to-bgp13 {
        term company {
            from {
                protocol aggregate;
                route-filter 80.1.1.0/24 exact;
            }
            then {
                as-path-prepend "1234 1234";
                accept;
            }
        }
        term lo0 {
            from {
                interface lo0.0;
                route-filter 80.1.1.16/32 exact;
            }
            then accept;
        }
    }
    policy-statement to-bgp9 {
        term company {
            from {
                protocol aggregate;
                route-filter 80.1.1.0/24 exact;
            }
            then accept;
        }
        term lo0 {
            from {
                interface lo0.0;
                route-filter 80.1.1.16/32 exact;
            }
            then {
                as-path-prepend "1234 1234";
                accept;
            }
        }
    }
    policy-statement to-ospf {
        term 1 {
            from {
                protocol aggregate;
                route-filter 172.16.0.0/16 exact;
            }
            then accept;
        }
    }
}
class-of-service {
    application-traffic-control {
        rate-limiters MEGA {
            bandwidth-limit 5000;
            burst-size-limit 15000;
        }
        rule-sets MEGA {
            rule rate {
                match {
                    application junos:MEGAUPLOAD;
                }
                then {
                    rate-limit {
                        client-to-server MEGA;
                        server-to-client MEGA;
                        loss-priority-high;
                    }
                }
            }
        }
    }
}
firewall {
    family inet {
        filter RE-PROTECT-v4 {
            term DNS {
                from {
                    source-address {
                        8.8.8.8/32;
                    }
                    port domain;
                }
                then accept;
            }
            term sdsn {
                from {
                    protocol tcp;
                    port [ https http 8080 ];
                }
                then accept;
            }
            term IFD {
                from {
                    interface st0;
                }
                then accept;
            }
            term PORT-UDP {
                from {
                    source-prefix-list {
                        mgmt;
                    }
                    protocol udp;
                    port [ domain ntp ];
                }
                then accept;
            }
            term LOG-UDP {
                from {
                    protocol udp;
                    port [ domain ntp ];
                }
                then {
                    count LOG-UDP;
                    discard;
                }
            }
            term PORT-TCP {
                from {
                    source-prefix-list {
                        mgmt;
                    }
                    protocol tcp;
                    destination-port [ https ssh ];
                }
                then accept;
            }
            term LOG-TCP {
                from {
                    protocol tcp;
                    destination-port [ https ssh ];
                }
                then {
                    count LOG-TCP;
                    discard;
                }
            }
            term ICMP {
                from {
                    protocol icmp;
                }
                then {
                    policer ICMP-POLICER;
                    accept;
                }
            }
            term SNMP {
                from {
                    source-prefix-list {
                        mgmt;
                    }
                    port [ snmp snmptrap ];
                }
                then {
                    count SNMP;
                    accept;
                }
            }
            term BGP {
                from {
                    prefix-list {
                        bgp;
                    }
                    protocol tcp;
                    port bgp;
                }
                then {
                    count BGP;
                    accept;
                }
            }
            term OSPF {
                from {
                    protocol ospf;
                }
                then {
                    count OSPF;
                    accept;
                }
            }
            term IKE {
                from {
                    port 500;
                }
                then {
                    count IKE;
                    accept;
                }
            }
        }
    }
    policer ICMP-POLICER {
        if-exceeding {
            bandwidth-limit 256k;
            burst-size-limit 100k;
        }
        then discard;
    }
}
routing-instances {
    apbr {
        instance-type forwarding;
        routing-options {
            static {
                route 0.0.0.0/0 {
                    next-hop 80.1.1.13;
                    qualified-next-hop 80.1.1.9 {
                        preference 7;
                    }
                }
            }
        }
    }
}
protocols {
    ospf {
        export to-ospf;
        area 0.0.0.0 {
            interface lo0.0 {
                passive;
            }
            interface st0.0 {
                interface-type p2mp;
                retransmit-interval 1;
                dead-interval 40;
                demand-circuit;
                dynamic-neighbors;
            }
        }
    }
    bgp {
        group untrust-v4 {
            type external;
            peer-as 4321;
            neighbor 80.1.1.9 {
                import from-bgp9;
                export to-bgp9;
            }
            neighbor 80.1.1.13 {
                import from-bgp13;
                export to-bgp13;
            }
        }
    }
}
routing-options {
    interface-routes {
        rib-group inet apbr;
    }
    rib inet6.0 {
        aggregate {
            route 2016:abcd::/32;
        }
    }
    static {
        route 172.16.100.0/24 next-hop 172.16.55.1;
        route 172.16.101.0/24 next-hop 172.16.55.1;
        route 172.16.200.0/24 next-hop 172.16.55.2;
        route 172.16.201.0/24 next-hop 172.16.55.2;
        route 172.16.61.0/24 next-hop 172.16.255.0;
        route 10.0.0.0/8 next-hop 10.10.1.254;
        route 172.16.110.0/24 next-hop 11.0.0.3;
        route 172.16.111.0/24 next-hop 11.0.0.1;
        route 172.16.77.0/24 next-hop st0.1;
    }
    aggregate {
        route 80.1.1.0/24 policy no-bgp;
        route 172.16.0.0/16;
    }
    rib-groups {
        apbr {
            import-rib [ inet.0 apbr.inet.0 ];
            import-policy apbr;
        }
    }
    autonomous-system 1234;
}
